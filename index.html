<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VPN ‚Äî Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0f0f0f; --text:#eaeaea; --hint:#9aa0a6; --link:#5ea0ff;
      --btn:#5ea0ff; --btn-text:#0b1020; --card:#151515; --border:#2a2a2a;
    }
    [data-theme="light"]{
      --bg:#ffffff; --text:#111; --hint:#667; --link:#0b62ff;
      --btn:#0b62ff; --btn-text:#fff; --card:#f6f7fb; --border:#e5e7eb;
    }
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg); color:var(--text);
    }
    .wrap{max-width:760px; margin:0 auto; padding:16px;}
    h1{margin:0 0 12px; font-size:20px}
    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 16px}
    .tab{
      padding:10px 12px; border-radius:10px; border:1px solid var(--border);
      background:var(--card); cursor:pointer; user-select:none;
    }
    .tab.active{ outline:2px solid var(--btn); }
    .card{
      border:1px solid var(--border); background:var(--card);
      border-radius:14px; padding:14px; margin:0 0 12px;
    }
    label{display:block; margin:8px 0 6px; font-size:14px; opacity:.9}
    input,select,textarea{
      width:100%; padding:12px; border-radius:12px; border:1px solid var(--border);
      background:transparent; color:var(--text); outline:none;
    }
    textarea{min-height:72px; resize:vertical}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      border:none; background:var(--btn); color:var(--btn-text);
      padding:12px 14px; border-radius:12px; cursor:pointer; font-weight:600;
    }
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    .muted{font-size:13px; color:var(--hint); margin-top:6px}
    .list{display:grid; gap:8px}
    .item{padding:10px; border:1px solid var(--border); border-radius:10px}
    a{color:var(--link); text-decoration:none}
    .right{display:flex; gap:8px; flex-wrap:wrap}
    .danger{background:#ef4444; color:#fff}
    .ok{background:#10b981; color:#072;}
    .warning{background:#f59e0b; color:#211;}
    .hidden{display:none}
  </style>
</head>
<body>
<div class="wrap">
  <h1>–ü–æ–¥–ø–∏—Å–∫–∞ VPN</h1>

  <div class="tabs" id="tabs"></div>

  <!-- DASHBOARD -->
  <section id="tab-dashboard" class="tabpage">
    <div class="card">
      <div id="me"></div>
      <div class="muted">–ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤–∞—à —Å—Ç–∞—Ç—É—Å –∏ –æ—Å—Ç–∞—Ç–æ–∫ –¥–Ω–µ–π.</div>
    </div>
  </section>

  <!-- BUY -->
  <section id="tab-buy" class="tabpage hidden">
    <div class="card">
      <label>–ü–∞–∫–µ—Ç</label>
      <select id="days">
        <option value="30">30 –¥–Ω–µ–π</option>
        <option value="60">60 –¥–Ω–µ–π (‚àí5%)</option>
        <option value="90">90 –¥–Ω–µ–π (‚àí10%)</option>
      </select>
      <div class="row">
        <div>
          <label>–ö–æ–ª-–≤–æ –ª—é–¥–µ–π</label>
          <select id="seats">
            <option>1</option><option>2</option><option>3</option>
            <option>4</option><option>5</option><option>6</option>
            <option>7</option><option>8</option><option>9</option><option>10</option>
          </select>
        </div>
        <div>
          <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <input id="comment" placeholder="–ò–º–µ–Ω–∞/–Ω–∏–∫–Ω–µ–π–º—ã –¥–ª—è –≥—Ä—É–ø–ø—ã"/>
        </div>
      </div>
      <div class="right" style="margin-top:10px">
        <button class="btn" id="btn-calc" type="button">üßÆ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
        <button class="btn" id="btn-buy" type="button" disabled>üí≥ –û—Ñ–æ—Ä–º–∏—Ç—å</button>
      </div>
      <div id="buy-info" class="muted"></div>
    </div>
  </section>

  <!-- PAYMENTS -->
  <section id="tab-payments" class="tabpage hidden">
    <div class="card">
      <div class="right" style="margin-bottom:10px">
        <button class="btn" id="btn-refresh" type="button">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div id="payments" class="list"></div>
      <div class="muted">–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è –≤–∞—à–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π.</div>
    </div>
  </section>

  <!-- PROFILE -->
  <section id="tab-profile" class="tabpage hidden">
    <div class="card">
      <label>–ù–∏–∫ (–≤–∏–¥–Ω–æ –∞–¥–º–∏–Ω—É)</label>
      <input id="prof-username" />
      <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
      <textarea id="prof-comment" placeholder="–ü–æ–∂–µ–ª–∞–Ω–∏—è, –∫–æ–Ω—Ç–∞–∫—Ç –∏ —Ç.–¥."></textarea>
      <div class="right" style="margin-top:10px">
        <button class="btn" id="btn-save-profile" type="button">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
      <div id="profile-info" class="muted"></div>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="tab-admin" class="tabpage hidden">
    <div class="card">
      <div class="row">
        <div>
          <label>–ü–æ–∏—Å–∫ (id –∏–ª–∏ username)</label>
          <input id="adm-q" placeholder="251385778 –∏–ª–∏ @username"/>
        </div>
        <div style="display:flex;align-items:end">
          <button class="btn" id="adm-search" type="button">üîé –ù–∞–π—Ç–∏</button>
        </div>
      </div>
      <div id="adm-users" class="list" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <div class="right">
        <button class="btn" id="adm-export" type="button">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (CSV)</button>
        <button class="btn" id="adm-backup" type="button">üíæ –ë—ç–∫–∞–ø –ë–î</button>
      </div>
      <div id="adm-info" class="muted"></div>
    </div>
  </section>

  <div class="muted" style="text-align:center;margin-top:16px" id="botname"></div>
</div>

<script>
  // ====== Telegram integration ======
  const tg = window.Telegram.WebApp;
  tg.ready();       // <‚Äî –≤–∞–∂–Ω–æ, –∏–Ω–∞—á–µ –±—ã–≤–∞—é—Ç "–Ω–µ –∫–ª–∏–∫–∞—é—Ç—Å—è"
  tg.expand();

  // Theme bind
  function applyTheme(){
    const p = tg.themeParams || {};
    const isDark = (tg.colorScheme || 'dark') === 'dark';
    document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
    // hard map only if present ‚Äî –∏–Ω–∞—á–µ –æ—Å—Ç–∞—é—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∏–∑ :root
    const map = {
      '--bg': p.bg_color, '--text': p.text_color, '--hint': p.hint_color,
      '--link': p.link_color, '--btn': p.button_color, '--btn-text': p.button_text_color,
      '--card': p.secondary_bg_color
    };
    const root = document.documentElement.style;
    Object.entries(map).forEach(([k,v])=>{ if(v){ root.setProperty(k, v); }});
  }
  applyTheme();
  tg.onEvent('themeChanged', applyTheme);

  document.getElementById('botname').textContent = tg.initDataUnsafe?.bot?.username
    ? '@' + tg.initDataUnsafe.bot.username : '';

  // ====== API helper ======
  // –í–°–¢–ê–í–¨ —Å—é–¥–∞ —Å–≤–æ–π –ø—É–±–ª–∏—á–Ω—ã–π HTTPS –±—ç–∫–µ–Ω–¥–∞ (–ø–æ–ª—É—á–∏—à—å –Ω–∞ —à–∞–≥–µ 3)
  const API_BASE = "https://botsite-mein.onrender.com/api";

  async function api(path, method='GET', body){
    const res = await fetch(API_BASE + path, {
      method,
      headers:{
        'Content-Type':'application/json',
        'X-Telegram-Init-Data': tg.initData || ''   // –ø–æ–¥–ø–∏—Å—å
      },
      body: body ? JSON.stringify(body) : undefined,
    });
    const data = await res.json().catch(()=>({ok:false,error:'bad_json'}));
    if(!res.ok || data.ok === false) throw new Error(data.error || `HTTP ${res.status}`);
    return data;
  }

  // ====== Tabs ======
  const tabs = [
    {id:'dashboard', label:'–°—Ç–∞—Ç—É—Å'},
    {id:'buy',       label:'–ö—É–ø–∏—Ç—å'},
    {id:'payments',  label:'–ü–ª–∞—Ç–µ–∂–∏'},
    {id:'profile',   label:'–ü—Ä–æ—Ñ–∏–ª—å'},
    // 'admin' –¥–æ–±–∞–≤–∏–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ is_admin
  ];
  function drawTabs(){
    const c = document.getElementById('tabs'); c.innerHTML='';
    for(const t of tabs){
      const el = document.createElement('div');
      el.className='tab'; el.dataset.id=t.id; el.textContent=t.label;
      el.onclick = ()=>activate(t.id);
      c.appendChild(el);
    }
  }
  function activate(id){
    document.querySelectorAll('.tab').forEach(x=>{
      x.classList.toggle('active', x.dataset.id === id);
    });
    document.querySelectorAll('.tabpage').forEach(x=>x.classList.add('hidden'));
    document.getElementById('tab-'+id).classList.remove('hidden');
  }

  // ====== Pages ======
  async function loadMe(){
    const me = await api('/me');
    document.getElementById('me').innerHTML =
      `<div><b>@${me.username || '–±–µ–∑ –Ω–∏–∫–∞'}</b><br>
        ID: ${me.user_id}<br>
        –û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π: <b>${me.days_left}</b>${me.expired_since ? ` (–∏—Å—Ç—ë–∫ —Å ${me.expired_since})` : ''}</div>`;
    // –ø—Ä–æ—Ñ–∏–ª—å:
    document.getElementById('prof-username').value = me.username || '';
    document.getElementById('prof-comment').value  = me.user_comment || '';
    // admin tab
    const has = tabs.find(t=>t.id==='admin');
    if(me.is_admin && !has){ tabs.push({id:'admin', label:'–ê–¥–º–∏–Ω'}); drawTabs(); }
  }

  async function recalc(){
    const days  = parseInt(document.getElementById('days').value,10);
    const seats = parseInt(document.getElementById('seats').value,10);
    const r = await api('/calc', 'POST', {days, seats});
    document.getElementById('buy-info').textContent = `–°—É–º–º–∞: ${r.amount} ‚ÇΩ`;
    document.getElementById('btn-buy').disabled = false;
  }

  async function doBuy(){
    const days  = parseInt(document.getElementById('days').value,10);
    const seats = parseInt(document.getElementById('seats').value,10);
    const comment = (document.getElementById('comment').value||'').trim() || null;
    const r = await api('/payment/create', 'POST', {days, seats, comment});
    document.getElementById('buy-info').innerHTML =
      `–°–æ–∑–¥–∞–Ω –ø–ª–∞—Ç—ë–∂ <b>#${r.payment_id}</b> –Ω–∞ <b>${r.amount} ‚ÇΩ</b>. 
       –°—Ç–∞—Ç—É—Å: <b>${r.status}</b>. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –∞–¥–º–∏–Ω –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç ‚Äî —Å—Ç–∞—Ç—É—Å —Å—Ç–∞–Ω–µ—Ç "paid".`;
    await loadPayments();
  }

  async function loadPayments(){
    const r = await api('/payments');
    const box = document.getElementById('payments'); box.innerHTML='';
    r.items.forEach(p=>{
      const el = document.createElement('div'); el.className='item';
      el.innerHTML = `#${p.payment_id} ‚Ä¢ ${p.days}–¥ √ó ${p.seats} —á–µ–ª = <b>${p.amount} ‚ÇΩ</b><br>
        –°—Ç–∞—Ç—É—Å: <b>${p.status}</b> ‚Ä¢ ${p.created_at}`;
      box.appendChild(el);
    });
  }

  async function saveProfile(){
    const username = document.getElementById('prof-username').value.trim() || null;
    const comment  = document.getElementById('prof-comment').value.trim() || null;
    await api('/profile', 'POST', {username, comment});
    document.getElementById('profile-info').textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ.';
    await loadMe();
  }

  // Admin
  async function admSearch(){
    const q = document.getElementById('adm-q').value.trim();
    const r = await api('/admin/users?q='+encodeURIComponent(q||'')); // GET
    const box = document.getElementById('adm-users'); box.innerHTML='';
    r.items.forEach(u=>{
      const el = document.createElement('div'); el.className='item';
      el.innerHTML = `<b>@${u.username||'‚Äî'}</b> (ID ${u.user_id}) ‚Ä¢ –î–Ω–µ–π: <b>${u.days_left}</b><br>
        <div class="right" style="margin-top:8px">
          <button class="btn" type="button" onclick="admAdd(${u.user_id},1)">+1</button>
          <button class="btn" type="button" onclick="admAdd(${u.user_id},7)">+7</button>
          <button class="btn" type="button" onclick="admAdd(${u.user_id},30)">+30</button>
          <button class="btn danger" type="button" onclick="admSub(${u.user_id},1)">‚àí1</button>
          <button class="btn danger" type="button" onclick="admSub(${u.user_id},7)">‚àí7</button>
          <button class="btn warning" type="button" onclick="admSet(${u.user_id})">Set‚Ä¶</button>
          <button class="btn ok" type="button" onclick="admConfirm(${u.user_id})">–ü–æ–¥—Ç–≤. –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–ª–∞—Ç—ë–∂</button>
        </div>`;
      box.appendChild(el);
    });
  }
  async function admAdd(uid,days){ await api('/admin/user/'+uid+'/add','POST',{days}); await admSearch(); }
  async function admSub(uid,days){ await api('/admin/user/'+uid+'/sub','POST',{days}); await admSearch(); }
  async function admSet(uid){
    const v = prompt('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–ª-–≤–æ –¥–Ω–µ–π:'); if(!v) return;
    await api('/admin/user/'+uid+'/set','POST',{days:parseInt(v,10)||0}); await admSearch();
  }
  async function admConfirm(uid){
    await api('/admin/user/'+uid+'/confirm_last_payment','POST',{}); await admSearch(); await loadPayments();
  }
  async function admExport(){
    const r = await api('/admin/export');
    const blob = new Blob([r.csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = 'users.csv'; a.click();
    document.getElementById('adm-info').textContent = '–≠–∫—Å–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤.';
  }
  async function admBackup(){
    const r = await api('/admin/backup');
    document.getElementById('adm-info').innerHTML = `–ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: <b>${r.file}</b>`;
  }

  // Buttons & events
  document.getElementById('btn-calc').addEventListener('click', recalc);
  document.getElementById('btn-buy').addEventListener('click', doBuy);
  document.getElementById('btn-refresh').addEventListener('click', loadPayments);
  document.getElementById('btn-save-profile').addEventListener('click', saveProfile);
  document.getElementById('adm-search').addEventListener('click', admSearch);
  document.getElementById('adm-export').addEventListener('click', admExport);
  document.getElementById('adm-backup').addEventListener('click', admBackup);

  // Init
  drawTabs();
  activate('dashboard');
  loadMe().then(()=>loadPayments()).catch(console.error);
</script>
</body>
</html>

