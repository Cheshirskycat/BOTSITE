<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>VPN ‚Äî Mini App</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{
  --bg:#0f1115; --text:#eef2f6; --hint:#9aa0a6; --link:#5ea0ff;
  --btn:#5ea0ff; --btn-text:#0b1020; --card:#151923; --border:#2a3242;
}
[data-theme="light"]{
  --bg:#ffffff; --text:#111; --hint:#667; --link:#0b62ff;
  --btn:#0b62ff; --btn-text:#fff; --card:#f6f7fb; --border:#e5e7eb;
}
html,body{height:100%}
body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text)}
.wrap{max-width:820px; margin:0 auto; padding:16px}
h1{margin:0 0 14px; font-size:22px}
.tabs{display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 16px}
.tab{padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:var(--card); cursor:pointer}
.tab.active{outline:2px solid var(--btn)}
.card{border:1px solid var(--border); background:var(--card); border-radius:14px; padding:14px; margin:0 0 12px}
label{display:block; margin:8px 0 6px; font-size:14px}
input,textarea{width:100%; padding:12px; border-radius:12px; border:1px solid var(--border); background:transparent; color:var(--text); outline:none}
textarea{min-height:72px; resize:vertical}
.right{display:flex; gap:8px; flex-wrap:wrap}
.btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; border:none; background:var(--btn); color:var(--btn-text); padding:12px 14px; border-radius:12px; cursor:pointer; font-weight:600}
.btn[disabled]{opacity:.5; cursor:not-allowed}
.btn.alt{background:transparent; color:var(--text); border:1px solid var(--border)}
.btn.alt.active{outline:2px solid var(--btn)}
.muted{font-size:13px; color:var(--hint); margin-top:6px}
.list{display:grid; gap:8px}
.item{padding:10px; border:1px solid var(--border); border-radius:10px}
.hidden{display:none}
</style>
</head>
<body>
<div class="wrap">
  <h1>–ü–æ–¥–ø–∏—Å–∫–∞ VPN</h1>
  <div class="tabs" id="tabs"></div>

  <!-- –°—Ç–∞—Ç—É—Å -->
  <section id="tab-dashboard" class="tabpage">
    <div class="card">
      <div id="me"></div>
      <div class="muted">–û—Å—Ç–∞—Ç–æ–∫ –¥–Ω–µ–π –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª—è.</div>
    </div>
  </section>

  <!-- –ö—É–ø–∏—Ç—å -->
  <section id="tab-buy" class="tabpage hidden">
    <div class="card">
      <label>–ü–∞–∫–µ—Ç</label>
      <div id="days-grid" class="right" style="flex-wrap:wrap">
        <button class="btn alt" data-days="30"  type="button">30 –¥–Ω–µ–π</button>
        <button class="btn alt" data-days="60"  type="button">60 –¥–Ω–µ–π (‚àí5%)</button>
        <button class="btn alt" data-days="90"  type="button">90 –¥–Ω–µ–π (‚àí10%)</button>
      </div>

      <label style="margin-top:10px">–ö–æ–ª-–≤–æ –ª—é–¥–µ–π</label>
      <div id="seats-grid" class="right" style="flex-wrap:wrap">
        <button class="btn alt" data-seats="1" type="button">1</button>
        <button class="btn alt" data-seats="2" type="button">2</button>
        <button class="btn alt" data-seats="3" type="button">3</button>
        <button class="btn alt" data-seats="4" type="button">4</button>
        <button class="btn alt" data-seats="5" type="button">5</button>
      </div>

      <label style="margin-top:10px">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <input id="comment" placeholder="–ò–º–µ–Ω–∞/–Ω–∏–∫–Ω–µ–π–º—ã –¥–ª—è –≥—Ä—É–ø–ø—ã"/>

      <div class="right" style="margin-top:10px">
        <button class="btn" id="btn-calc" type="button">üßÆ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
        <button class="btn" id="btn-buy"  type="button" disabled>üí≥ –û—Ñ–æ—Ä–º–∏—Ç—å</button>
      </div>
      <div id="buy-info" class="muted"></div>
    </div>
  </section>

  <!-- –ü–ª–∞—Ç–µ–∂–∏ -->
  <section id="tab-payments" class="tabpage hidden">
    <div class="card">
      <div class="right" style="margin-bottom:10px">
        <button class="btn" id="btn-refresh" type="button">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div id="payments" class="list"></div>
      <div class="muted">–ò—Å—Ç–æ—Ä–∏—è –≤–∞—à–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π.</div>
    </div>
  </section>

  <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
  <section id="tab-profile" class="tabpage hidden">
    <div class="card">
      <label>–ù–∏–∫ (–≤–∏–¥–Ω–æ –∞–¥–º–∏–Ω—É)</label>
      <input id="prof-username"/>
      <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
      <textarea id="prof-comment" placeholder="–ü–æ–∂–µ–ª–∞–Ω–∏—è, –∫–æ–Ω—Ç–∞–∫—Ç –∏ —Ç.–¥."></textarea>
      <div class="right" style="margin-top:10px">
        <button class="btn" id="btn-save-profile" type="button">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
      <div id="profile-info" class="muted"></div>
    </div>
  </section>

  <!-- –ê–¥–º–∏–Ω -->
  <section id="tab-admin" class="tabpage hidden">
    <div class="card">
      <div class="right" style="margin-bottom:10px">
        <input id="adm-q" placeholder="–ü–æ–∏—Å–∫: id –∏–ª–∏ @username" style="flex:1; min-width:240px"/>
        <button class="btn" id="adm-search" type="button">üîé –ù–∞–π—Ç–∏</button>
        <button class="btn" type="button" onclick="admQueue()">üïó –û–∂–∏–¥–∞—é—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</button>
      </div>
      <div id="adm-users" class="list"></div>
      <hr style="border:0;border-top:1px solid var(--border);margin:12px 0">
      <div id="adm-pending" class="list"></div>
    </div>

    <div class="card">
      <div class="right">
        <button class="btn" id="adm-export" type="button">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (CSV)</button>
        <button class="btn" id="adm-backup" type="button">üíæ –ë—ç–∫–∞–ø –ë–î</button>
      </div>
      <div id="adm-info" class="muted"></div>
    </div>
  </section>

  <div class="muted" style="text-align:center;margin-top:16px" id="botname"></div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.ready(); tg.expand();

// ===== Theme
function applyTheme(){
  const p = tg.themeParams || {};
  const isDark = (tg.colorScheme || 'dark') === 'dark';
  document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
  const map = {
    '--bg': p.bg_color, '--text': p.text_color, '--hint': p.hint_color,
    '--link': p.link_color, '--btn': p.button_color, '--btn-text': p.button_text_color,
    '--card': p.secondary_bg_color
  };
  const root = document.documentElement.style;
  Object.entries(map).forEach(([k,v])=>{ if(v){ root.setProperty(k, v); }});
}
applyTheme(); tg.onEvent('themeChanged', applyTheme);

document.getElementById('botname').textContent = tg.initDataUnsafe?.bot?.username ? '@'+tg.initDataUnsafe.bot.username : '';

// ===== API
const API_BASE = "https://slow-bottles-taste.loca.lt/api"; // <<< –í–°–¢–ê–í–¨ —Å–≤–æ–π lt-–∞–¥—Ä–µ—Å

async function api(path, method='GET', body){
  const res = await fetch(API_BASE + path, {
    method,
    headers:{
      'Content-Type':'application/json',
      'X-Telegram-Init-Data': tg.initData || ''
    },
    body: body ? JSON.stringify(body) : undefined
  });
  const data = await res.json().catch(()=>({ok:false,error:'bad_json'}));
  if(!res.ok || data.ok === false) throw new Error(data.error || `HTTP ${res.status}`);
  return data;
}

// ===== Tabs
const tabs = [
  {id:'dashboard', label:'–°—Ç–∞—Ç—É—Å'},
  {id:'buy',       label:'–ö—É–ø–∏—Ç—å'},
  {id:'payments',  label:'–ü–ª–∞—Ç–µ–∂–∏'},
  {id:'profile',   label:'–ü—Ä–æ—Ñ–∏–ª—å'},
];

function drawTabs(){ const c = document.getElementById('tabs'); c.innerHTML='';
  tabs.forEach(t=>{ const el = document.createElement('div'); el.className='tab'; el.dataset.id=t.id; el.textContent=t.label; el.onclick=()=>activate(t.id); c.appendChild(el);});
}
function activate(id){
  document.querySelectorAll('.tab').forEach(x=>x.classList.toggle('active', x.dataset.id===id));
  document.querySelectorAll('.tabpage').forEach(x=>x.classList.add('hidden'));
  document.getElementById('tab-'+id).classList.remove('hidden');
}

// ===== Pages
async function loadMe(){
  const me = await api('/me');
  document.getElementById('me').innerHTML =
    `<b>@${me.username || '‚Äî'}</b> (ID ${me.user_id})<br>
     –û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π: <b>${me.days_left}</b>${me.expired_since ? ' ‚Ä¢ –∏—Å—Ç—ë–∫ —Å '+me.expired_since : ''}`;
  document.getElementById('prof-username').value = me.username || '';
  document.getElementById('prof-comment').value  = me.user_comment || '';
  if(me.is_admin && !tabs.find(t=>t.id==='admin')){ tabs.push({id:'admin',label:'–ê–¥–º–∏–Ω'}); drawTabs(); }
}

let selDays=30, selSeats=1;
function bindTiles(){
  document.querySelectorAll('#days-grid .btn').forEach(b=>{
    b.onclick=()=>{ selDays=parseInt(b.dataset.days,10);
      document.querySelectorAll('#days-grid .btn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active'); document.getElementById('btn-buy').disabled=true; document.getElementById('buy-info').textContent=''; };
  });
  document.querySelector('#days-grid .btn[data-days="30"]').classList.add('active');

  document.querySelectorAll('#seats-grid .btn').forEach(b=>{
    b.onclick=()=>{ selSeats=parseInt(b.dataset.seats,10);
      document.querySelectorAll('#seats-grid .btn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active'); document.getElementById('btn-buy').disabled=true; document.getElementById('buy-info').textContent=''; };
  });
  document.querySelector('#seats-grid .btn[data-seats="1"]').classList.add('active');
}
bindTiles();

async function recalc(){
  const r = await api('/calc','POST',{days:selDays,seats:selSeats});
  document.getElementById('buy-info').textContent = `–°—É–º–º–∞: ${r.amount} ‚ÇΩ`;
  document.getElementById('btn-buy').disabled=false;
}
async function doBuy(){
  const comment=(document.getElementById('comment').value||'').trim()||null;
  const r=await api('/payment/create','POST',{days:selDays,seats:selSeats,comment});
  document.getElementById('buy-info').innerHTML=`–°–æ–∑–¥–∞–Ω –ø–ª–∞—Ç—ë–∂ <b>#${r.payment_id}</b> –Ω–∞ <b>${r.amount} ‚ÇΩ</b> ‚Ä¢ —Å—Ç–∞—Ç—É—Å <b>${r.status}</b>`;
  await loadPayments();
}
async function loadPayments(){
  const r=await api('/payments'); const box=document.getElementById('payments'); box.innerHTML='';
  r.items.forEach(p=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML = `#${p.payment_id} ‚Ä¢ ${p.days}–¥ √ó ${p.seats} = <b>${p.amount} ‚ÇΩ</b><br>–°—Ç–∞—Ç—É—Å: <b>${p.status}</b> ‚Ä¢ ${p.created_at}`;
    box.appendChild(el);
  });
}
async function saveProfile(){
  const username=(document.getElementById('prof-username').value||'').trim()||null;
  const comment=(document.getElementById('prof-comment').value||'').trim()||null;
  await api('/profile','POST',{username,comment});
  document.getElementById('profile-info').textContent='–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ.'; await loadMe();
}

// ===== Admin
async function admSearch(){
  const q=document.getElementById('adm-q').value.trim();
  const r=await api('/admin/users'+(q?`?q=${encodeURIComponent(q)}`:'')); const box=document.getElementById('adm-users'); box.innerHTML='';
  r.items.forEach(u=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML = `<b>@${u.username||'‚Äî'}</b> (ID ${u.user_id}) ‚Ä¢ –î–Ω–µ–π: <b>${u.days_left}</b>
      <div class="right" style="margin-top:8px">
        <button class="btn" type="button" onclick="admOpenUser(${u.user_id})">–ü—Ä–æ—Ñ–∏–ª—å</button>
        <button class="btn" type="button" onclick="admAdd(${u.user_id},7)">+7</button>
        <button class="btn" type="button" onclick="admAdd(${u.user_id},30)">+30</button>
        <button class="btn" type="button" onclick="admSet(${u.user_id})">Set‚Ä¶</button>
        <button class="btn" type="button" onclick="admSub(${u.user_id},1)">‚àí1</button>
      </div>`;
    box.appendChild(el);
  });
}
async function admOpenUser(uid){
  const r=await api('/admin/user/'+uid); const u=r.profile;
  const pays=r.payments.map(p=>`#${p.payment_id} ‚Ä¢ ${p.days}–¥√ó${p.seats} = ${p.amount} ‚ÇΩ ‚Ä¢ ${p.status}`).join('\n');
  alert(`@${u.username||'‚Äî'} (ID ${u.user_id})\n–î–Ω–µ–π: ${u.days_left}\n–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${u.user_comment||'‚Äî'}\n--- –ü–ª–∞—Ç–µ–∂–∏ ---\n${pays || '–Ω–µ—Ç'}`);
}
async function admQueue(){
  const r=await api('/admin/payments?status=pending'); const box=document.getElementById('adm-pending'); box.innerHTML='';
  r.items.forEach(p=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML = `#${p.payment_id} ‚Ä¢ user ${p.user_id} ‚Ä¢ ${p.days}–¥ √ó ${p.seats} = <b>${p.amount} ‚ÇΩ</b>
      <div class="right" style="margin-top:8px">
        <button class="btn" type="button" onclick="admOpenUser(${p.user_id})">–ü—Ä–æ—Ñ–∏–ª—å</button>
        <button class="btn" type="button" onclick="admConfirmPayment(${p.payment_id})">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
      </div>`;
    box.appendChild(el);
  });
}
async function admConfirmPayment(pid){
  await api('/admin/payment/'+pid+'/confirm','POST',{}); await admQueue(); await loadMe(); await loadPayments();
}
async function admAdd(uid,days){ await api('/admin/user/'+uid+'/add','POST',{days}); await admSearch(); }
async function admSub(uid,days){ await api('/admin/user/'+uid+'/sub','POST',{days}); await admSearch(); }
async function admSet(uid){ const v=prompt('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–Ω–µ–π:'); if(!v) return; await api('/admin/user/'+uid+'/set','POST',{days:parseInt(v,10)||0}); await admSearch(); }

async function admExport(){
  const r=await api('/admin/export'); const blob=new Blob([r.csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='users.csv'; a.click();
  document.getElementById('adm-info').textContent='–≠–∫—Å–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤.';
}
async function admBackup(){ const r=await api('/admin/backup'); document.getElementById('adm-info').textContent='–ë—ç–∫–∞–ø: '+r.file; }

// ===== Events
document.getElementById('btn-calc').addEventListener('click', recalc);
document.getElementById('btn-buy').addEventListener('click', doBuy);
document.getElementById('btn-refresh').addEventListener('click', loadPayments);
document.getElementById('btn-save-profile').addEventListener('click', saveProfile);
document.getElementById('adm-search').addEventListener('click', admSearch);

// ===== Init + polling
drawTabs(); activate('dashboard');
loadMe().then(loadPayments).catch(console.error);

let pollTimer=null;
function startPolling(){
  if(pollTimer) clearInterval(pollTimer);
  pollTimer=setInterval(async ()=>{
    try{
      await loadMe();
      await loadPayments();
      if(!document.getElementById('tab-admin').classList.contains('hidden')) await admQueue();
    }catch(e){}
  }, 5000);
}
startPolling();
</script>
</body>
</html>
